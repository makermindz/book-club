<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pythonic Quest - A Coding Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'py-blue': '#306998',
                        'py-yellow': '#FFD43B',
                        'brand-dark': '#1e293b',
                        'paper': '#fdfbf7',
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'Courier New', 'monospace'],
                        serif: ['Georgia', 'Cambria', 'Times New Roman', 'Times', 'serif'],
                    },
                    boxShadow: {
                        'book': '0 20px 30px -10px rgba(0, 0, 0, 0.3), 0 0 10px rgba(0,0,0,0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #ffffff;
            /* background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px; */
        }
        
        .book-container {
            perspective: 1500px;
        }

        .book-page {
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
            transform-style: preserve-3d;
            transform-origin: left center;
        }

        /* Simulation Canvas Styles */
        canvas {
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            background-color: #fff;
            cursor: pointer;
        }

        .sim-control-panel {
            background: #f0f9ff;
            border: 1px solid #306998;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* Custom Range Slider */
        input[type=range] {
            height: 6px;
            background: #e2e8f0;
            border-radius: 5px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #306998;
            cursor: pointer;
        }

        code {
            background-color: #f1f5f9;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #d63384;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center overflow-hidden">

    <div class="book-container w-full max-w-5xl h-[90vh] relative flex items-center justify-center">
        
        <!-- Book Spine/Back -->
        <div class="absolute inset-0 bg-brand-dark rounded-r-2xl shadow-2xl transform translate-x-2 translate-y-2"></div>

        <!-- Active Page Container -->
        <div id="book-page" class="book-page relative w-full h-full bg-paper rounded-r-xl shadow-book flex flex-col md:flex-row overflow-hidden border-l-8 border-gray-200">
            
            <!-- Left Side: Story & Text -->
            <div class="w-full md:w-1/3 p-8 md:p-12 flex flex-col justify-center border-r border-gray-100 bg-white relative">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-py-blue to-py-yellow"></div>
                
                <div class="mb-4 text-py-blue font-bold uppercase tracking-widest text-xs">
                    Page <span id="page-num">1</span> of <span id="total-pages">24</span>
                </div>
                
                <h2 id="story-title" class="text-3xl font-serif font-bold text-brand-dark mb-6 leading-tight"></h2>
                
                <div id="story-text" class="prose text-gray-600 leading-relaxed mb-8 text-sm overflow-y-auto max-h-[40vh] pr-2">
                    <!-- Story content injected here -->
                </div>

                <div class="mt-auto flex gap-4">
                    <button onclick="Book.prevPage()" id="btn-prev" class="flex-1 px-4 py-3 rounded-lg border-2 border-gray-200 text-gray-500 font-bold hover:border-brand-dark hover:text-brand-dark transition disabled:opacity-30 disabled:cursor-not-allowed">
                        ‚Üê Previous
                    </button>
                    <button onclick="Book.nextPage()" id="btn-next" class="flex-1 px-4 py-3 rounded-lg bg-py-blue text-white font-bold hover:bg-sky-700 shadow-lg transition transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next <br> ‚Üí
                    </button>
                </div>
            </div>

            <!-- Right Side: Interactive Simulation -->
            <div class="w-full md:w-2/3 bg-slate-50 relative p-6 flex flex-col items-center justify-center">
                <div class="absolute top-4 right-4 text-black text-s font-sans z-20">
                    &copy; Maker Mindz
                </div>
                <div class="absolute top-6 right-6 text-brand-dark opacity-10 text-9xl font-serif font-bold select-none">
                    üêç
                </div>
                
                <div id="sim-container" class="w-full max-w-2xl z-10">
                    <div class="bg-white p-2 rounded-xl shadow-lg border border-gray-200">
                        <canvas id="sim-canvas" width="600" height="350" class="w-full h-auto bg-gray-50 rounded-lg"></canvas>
                    </div>
                    
                    <div id="sim-controls" class="sim-control-panel shadow-sm min-h-[80px] flex flex-col justify-center">
                        <!-- Controls injected here -->
                    </div>
                    
                    <div id="sim-feedback" class="mt-3 text-center font-bold text-brand-dark min-h-[1.5rem]"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- BOOK CONTENT & LOGIC ---
        
        const Pages = [
            {
                title: "The Pythonic Quest",
                text: "Welcome, Traveler! You are about to enter the Realm of Python, a land where words become magic spells (code) that control the world around you. Your journey to become a Coding Wizard starts now!",
                simType: "cover",
                instruction: "Click 'Next Page' to begin your adventure."
            },
            {
                title: "The First Spell: Print",
                text: "In Python, the <code>print()</code> function is your voice. It allows you to display messages to the world. To cast it, you simply wrap your text in quotes inside the parentheses.",
                simType: "print",
                instruction: "Click the button to execute: print('Hello World')"
            },
            {
                title: "Variables: The Magic Boxes",
                text: "A <b>Variable</b> is like a labeled box where you can store information. You give the box a name (like <code>score</code> or <code>name</code>) and put a value inside it using the <code>=</code> sign.",
                simType: "variables",
                instruction: "Click to assign the value 'Gem' to the variable 'treasure'."
            },
            {
                title: "Data Types: The Shapes of Magic",
                text: "Not all magic is the same. <b>Integers</b> are whole numbers (5). <b>Floats</b> are decimals (5.5). <b>Strings</b> are text ('Hello'). Python needs to know what type of data is in the box.",
                simType: "datatypes",
                instruction: "Click the shapes to identify their type."
            },
            {
                title: "Strings: Weaving Words",
                text: "Strings are chains of characters. You can stitch them together using the <code>+</code> operator. This is called <b>concatenation</b>.",
                simType: "strings",
                instruction: "Combine 'Super' + 'Python' to create a new string."
            },
            {
                title: "Numbers: The Calculator Golem",
                text: "Python is a powerful calculator. You can add <code>+</code>, subtract <code>-</code>, multiply <code>*</code>, and divide <code>/</code>. The Golem obeys your math commands.",
                simType: "math",
                instruction: "Adjust the sliders to add two numbers."
            },
            {
                title: "Booleans: The Torch of Truth",
                text: "A <b>Boolean</b> is a simple type that can only be <code>True</code> or <code>False</code>. It's like a light switch - it's either ON or OFF.",
                simType: "booleans",
                instruction: "Toggle the switch to change the Boolean value."
            },
            {
                title: "Comparisons: The Scales",
                text: "We use comparison operators to compare values. <code>==</code> checks if equal, <code>></code> checks if greater, and <code><</code> checks if smaller. The result is always a Boolean.",
                simType: "comparison",
                instruction: "Compare the weights on the scale."
            },
            {
                title: "If Statements: The Fork in the Road",
                text: "Code can make decisions! An <code>if</code> statement checks a condition. If it's True, the code block runs. If False, it skips it.",
                simType: "if_statement",
                instruction: "Set the condition to True to let the hero pass."
            },
            {
                title: "Else: The Other Path",
                text: "What if the condition is False? The <code>else</code> keyword defines an alternative path. If the first condition fails, the code jumps to the else block.",
                simType: "else_statement",
                instruction: "Toggle the switch to choose between the Forest or the Cave."
            },
            {
                title: "Lists: The Inventory",
                text: "A <b>List</b> is a collection of items in a specific order. You define it with square brackets <code>[]</code>. You can store many items in one variable!",
                simType: "lists",
                instruction: "Click 'Add' to put items into your inventory list."
            },
            {
                title: "List Indexing: The Shelf",
                text: "To get an item from a list, you use its <b>Index</b>. Warning: Python starts counting at 0! The first item is at index 0.",
                simType: "indexing",
                instruction: "Select Index 1 to grab the second potion."
            },
            {
                title: "For Loops: The Repeating Rune",
                text: "A <code>for</code> loop allows you to iterate over a list, running the same code for each item. It's great for processing inventory or repeating actions.",
                simType: "for_loop",
                instruction: "Run the loop to visit every island."
            },
            {
                title: "Range(): The Counter",
                text: "The <code>range()</code> function generates a sequence of numbers. <code>for i in range(5):</code> will run the loop 5 times, with <code>i</code> going from 0 to 4.",
                simType: "range",
                instruction: "Drag the slider to set the range limit."
            },
            {
                title: "While Loops: The Endurance Trial",
                text: "A <code>while</code> loop keeps running as long as a condition is True. Be careful! If the condition never becomes False, you get an Infinite Loop!",
                simType: "while_loop",
                instruction: "Fill the bucket while it is not full."
            },
            {
                title: "Functions: The Spellbook",
                text: "A <b>Function</b> is a block of reusable code. You define it once with <code>def</code>, and then you can 'call' it by name whenever you need it.",
                simType: "functions",
                instruction: "Call the 'Cast Fireball' function."
            },
            {
                title: "Parameters: Ingredients",
                text: "Functions can take inputs called <b>Parameters</b>. This makes them flexible. A <code>greet(name)</code> function can say hello to anyone you pass to it.",
                simType: "parameters",
                instruction: "Change the parameter to change the spell color."
            },
            {
                title: "Return: The Golden Boomerang",
                text: "A function can send a value back to where it was called using the <code>return</code> keyword. This lets you use the result in other parts of your code.",
                simType: "return",
                instruction: "Call the function to calculate and return the gold."
            },
            {
                title: "Dictionaries: The Keymaster",
                text: "A <b>Dictionary</b> stores data in Key-Value pairs <code>{'key': 'value'}</code>. It's like a real dictionary: you look up a word (Key) to find its definition (Value).",
                simType: "dictionaries",
                instruction: "Enter a Key to unlock the corresponding Value."
            },
            {
                title: "Modules: The Library",
                text: "Python has a massive library of pre-written code called <b>Modules</b>. You can <code>import</code> them to add powers like random numbers, math, or time functions.",
                simType: "modules",
                instruction: "Import the 'random' module to roll a die."
            },
            {
                title: "Classes: The Blueprint",
                text: "<b>Object-Oriented Programming</b> uses Classes. A Class is a blueprint for creating Objects. For example, a 'Robot' class defines how all robots look and act.",
                simType: "classes",
                instruction: "Use the blueprint to build a Robot instance."
            },
            {
                title: "Objects: The Army",
                text: "Once you have a Class, you can create many <b>Objects</b> (instances) from it. Each object has its own data but follows the same structure.",
                simType: "objects",
                instruction: "Create multiple robot objects with different colors."
            },
            {
                title: "Debugging: The Bug Hunt",
                text: "Errors (bugs) are part of coding. Syntax errors, logic errors, and exceptions happen to everyone. Reading error messages is a superpower.",
                simType: "debugging",
                instruction: "Find and fix the syntax error in the code."
            },
            {
                title: "Test Your Knowledge",
                text: "To earn your title, you must prove your skills. Complete the coding challenges below.",
                simType: "drag_drop_code",
                instruction: "Drag blocks to the Code Area to match the goal."
            }
        ];

        const Book = {
            currentPage: 0,
            
            init: function() {
                this.renderPage();
            },

            nextPage: function() {
                if (this.currentPage < Pages.length - 1) {
                    this.currentPage++;
                    this.renderPage();
                } else {
                    this.currentPage = 0;
                    this.renderPage();
                }
            },

            prevPage: function() {
                if (this.currentPage > 0) {
                    this.currentPage--;
                    this.renderPage();
                }
            },

            renderPage: function() {
                const page = Pages[this.currentPage];
                
                // Update Text
                document.getElementById('page-num').textContent = this.currentPage + 1;
                document.getElementById('total-pages').textContent = Pages.length;
                document.getElementById('story-title').textContent = page.title;
                document.getElementById('story-text').innerHTML = `<p>${page.text}</p><p class="mt-4 text-sm font-bold text-py-blue italic">Task: ${page.instruction}</p>`;
                
                // Update Buttons
                document.getElementById('btn-prev').disabled = this.currentPage === 0;
                document.getElementById('btn-next').disabled = false;
                if (this.currentPage === Pages.length - 1) {
                    document.getElementById('btn-next').textContent = "Restart";
                } else {
                    document.getElementById('btn-next').innerHTML = "Next <br> ‚Üí";
                }

                // Load Simulation
                Simulations.load(page.simType);
            }
        };

        const Simulations = {
            canvas: null,
            ctx: null,
            animId: null,
            activeType: null,
            state: {},

            load: function(type) {
                if (this.animId) cancelAnimationFrame(this.animId);
                this.activeType = type;
                this.canvas = document.getElementById('sim-canvas');
                // Reset event listeners
                const newCanvas = this.canvas.cloneNode(true);
                this.canvas.parentNode.replaceChild(newCanvas, this.canvas);
                this.canvas = newCanvas;
                this.ctx = this.canvas.getContext('2d');
                
                // Reset controls
                document.getElementById('sim-controls').innerHTML = '';
                document.getElementById('sim-feedback').textContent = '';
                document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-brand-dark min-h-[1.5rem]";

                // Initialize specific simulation
                if (this[type]) this[type].init(this);
                else this.placeholder.init(this);
            },

            placeholder: {
                init: function(sim) {
                    sim.ctx.clearRect(0,0,600,350);
                    sim.ctx.fillStyle = "#bdc3c7";
                    sim.ctx.font = "20px sans-serif";
                    sim.ctx.textAlign = "center";
                    sim.ctx.fillText("Interactive Visual Coming Soon", 300, 175);
                }
            },

            // 1. COVER
            cover: {
                init: function(sim) {
                    sim.state = { t: 0 };
                    sim.loop = () => {
                        const ctx = sim.ctx;
                        sim.state.t += 0.05;
                        ctx.fillStyle = '#1e293b';
                        ctx.fillRect(0, 0, 600, 350);
                        
                        // Draw Python Logo-ish snakes
                        ctx.save();
                        ctx.translate(300, 175);
                        ctx.rotate(Math.sin(sim.state.t) * 0.1);
                        
                        // Blue Snake
                        ctx.fillStyle = '#306998';
                        ctx.beginPath(); ctx.arc(-20, -20, 40, 0, Math.PI*2); ctx.fill();
                        ctx.fillRect(-40, -20, 40, 60);
                        ctx.beginPath(); ctx.arc(0, 40, 20, 0, Math.PI*2); ctx.fill();
                        
                        // Yellow Snake
                        ctx.fillStyle = '#FFD43B';
                        ctx.beginPath(); ctx.arc(20, 20, 40, 0, Math.PI*2); ctx.fill();
                        ctx.fillRect(0, -40, 40, 60);
                        ctx.beginPath(); ctx.arc(0, -40, 20, 0, Math.PI*2); ctx.fill();
                        
                        ctx.restore();

                        ctx.fillStyle = '#fff'; ctx.font = 'bold 30px sans-serif'; ctx.textAlign = 'center';
                        ctx.fillText("The Pythonic Quest", 300, 320);
                        
                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 2. PRINT
            print: {
                init: function(sim) {
                    sim.state = { printed: false };
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-green-600 text-white rounded font-bold font-mono";
                    btn.textContent = "Run Code ‚ñ∂";
                    btn.onclick = () => sim.state.printed = true;
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Terminal Window
                        ctx.fillStyle = '#000'; ctx.fillRect(50, 50, 500, 250);
                        ctx.fillStyle = '#333'; ctx.fillRect(50, 50, 500, 30); // Bar
                        ctx.fillStyle = '#fff'; ctx.font = '14px monospace'; ctx.textAlign = 'left';
                        ctx.fillText("Terminal", 60, 70);

                        ctx.fillStyle = '#0f0'; ctx.font = '20px monospace';
                        ctx.fillText("> print('Hello World')", 70, 120);
                        
                        if(sim.state.printed) {
                            ctx.fillStyle = '#fff';
                            ctx.fillText("Hello World", 70, 160);
                            document.getElementById('sim-feedback').textContent = "Output successful!";
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 3. VARIABLES
            variables: {
                init: function(sim) {
                    sim.state = { hasValue: false };
                    sim.canvas.onclick = () => sim.state.hasValue = true;

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Box
                        ctx.fillStyle = '#e67e22'; ctx.fillRect(250, 150, 100, 100);
                        ctx.strokeStyle = '#d35400'; ctx.lineWidth = 4; ctx.strokeRect(250, 150, 100, 100);
                        ctx.fillStyle = '#fff'; ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center';
                        ctx.fillText("treasure", 300, 280);

                        // Value
                        if(sim.state.hasValue) {
                            ctx.fillStyle = '#9b59b6';
                            ctx.beginPath(); ctx.arc(300, 200, 30, 0, Math.PI*2); ctx.fill();
                            ctx.fillStyle = '#fff'; ctx.fillText("'Gem'", 300, 205);
                            document.getElementById('sim-feedback').textContent = "treasure = 'Gem'";
                        } else {
                            ctx.fillStyle = '#9b59b6';
                            ctx.beginPath(); ctx.arc(100, 200, 30, 0, Math.PI*2); ctx.fill();
                            ctx.fillStyle = '#fff'; ctx.fillText("'Gem'", 100, 205);
                            document.getElementById('sim-feedback').textContent = "Click to assign.";
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 4. DATA TYPES
            datatypes: {
                init: function(sim) {
                    sim.state = {
                        items: [
                            { x: 150, y: 100, type: 'int', val: '42', color: '#e74c3c', shape: 'square', revealed: false },
                            { x: 450, y: 100, type: 'float', val: '3.14', color: '#3498db', shape: 'circle', revealed: false },
                            { x: 150, y: 250, type: 'str', val: '"Hi"', color: '#f1c40f', shape: 'rect', revealed: false },
                            { x: 450, y: 250, type: 'bool', val: 'True', color: '#9b59b6', shape: 'diamond', revealed: false }
                        ]
                    };

                    sim.canvas.onclick = (e) => {
                        const rect = sim.canvas.getBoundingClientRect();
                        const mx = e.clientX - rect.left;
                        const my = e.clientY - rect.top;
                        
                        sim.state.items.forEach(item => {
                            if (Math.abs(mx - item.x) < 50 && Math.abs(my - item.y) < 50) {
                                item.revealed = !item.revealed;
                            }
                        });
                    };

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        sim.state.items.forEach(item => {
                            ctx.fillStyle = item.color;
                            
                            if (item.shape === 'square') {
                                ctx.fillRect(item.x - 40, item.y - 40, 80, 80);
                            } else if (item.shape === 'circle') {
                                ctx.beginPath(); ctx.arc(item.x, item.y, 45, 0, Math.PI*2); ctx.fill();
                            } else if (item.shape === 'rect') {
                                ctx.fillRect(item.x - 50, item.y - 30, 100, 60);
                            } else if (item.shape === 'diamond') {
                                ctx.beginPath(); ctx.moveTo(item.x, item.y-50); ctx.lineTo(item.x+50, item.y); ctx.lineTo(item.x, item.y+50); ctx.lineTo(item.x-50, item.y); ctx.fill();
                            }

                            ctx.fillStyle = '#fff';
                            ctx.font = 'bold 20px monospace';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            
                            if (item.revealed) {
                                ctx.fillStyle = '#000';
                                ctx.fillText(item.type, item.x, item.y);
                            } else {
                                ctx.fillText(item.val, item.x, item.y);
                            }
                        });
                        
                        if (sim.state.items.every(i => i.revealed)) {
                            document.getElementById('sim-feedback').textContent = "All types revealed! Great job!";
                            document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-green-600 min-h-[1.5rem]";
                        } else {
                            document.getElementById('sim-feedback').textContent = "Click shapes to reveal types.";
                            document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-brand-dark min-h-[1.5rem]";
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 5. STRINGS
            strings: {
                init: function(sim) {
                    sim.state = { joined: false };
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-blue-600 text-white rounded font-bold";
                    btn.textContent = "Concatenate (+)";
                    btn.onclick = () => sim.state.joined = true;
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        if(sim.state.joined) {
                            ctx.fillStyle = '#2ecc71'; ctx.fillRect(200, 150, 200, 50);
                            ctx.fillStyle = '#fff'; ctx.font = '24px monospace'; ctx.textAlign = 'center';
                            ctx.fillText("'SuperPython'", 300, 182);
                        } else {
                            ctx.fillStyle = '#3498db'; ctx.fillRect(150, 150, 100, 50);
                            ctx.fillStyle = '#fff'; ctx.font = '24px monospace'; ctx.textAlign = 'center';
                            ctx.fillText("'Super'", 200, 182);

                            ctx.fillStyle = '#f1c40f'; ctx.fillRect(350, 150, 100, 50);
                            ctx.fillStyle = '#000'; 
                            ctx.fillText("'Python'", 400, 182);
                            
                            ctx.fillStyle = '#000'; ctx.fillText("+", 300, 182);
                        }
                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 6. MATH
            math: {
                init: function(sim) {
                    sim.state = { a: 5, b: 3 };
                    document.getElementById('sim-controls').innerHTML = `
                        <div class="flex gap-4 justify-center">
                            <input type="range" min="1" max="10" value="5" oninput="Simulations.state.a=parseInt(this.value)">
                            <span class="font-bold text-xl">+</span>
                            <input type="range" min="1" max="10" value="3" oninput="Simulations.state.b=parseInt(this.value)">
                        </div>
                    `;

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Golem Body
                        ctx.fillStyle = '#7f8c8d'; ctx.fillRect(250, 100, 100, 150);
                        // Screen
                        ctx.fillStyle = '#000'; ctx.fillRect(260, 120, 80, 40);
                        ctx.fillStyle = '#0f0'; ctx.font = '24px monospace'; ctx.textAlign = 'center';
                        ctx.fillText(sim.state.a + sim.state.b, 300, 148);

                        // Inputs
                        ctx.fillStyle = '#3498db'; ctx.beginPath(); ctx.arc(200, 200, 30, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#fff'; ctx.fillText(sim.state.a, 200, 208);

                        ctx.fillStyle = '#e74c3c'; ctx.beginPath(); ctx.arc(400, 200, 30, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#fff'; ctx.fillText(sim.state.b, 400, 208);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 7. BOOLEANS
            booleans: {
                init: function(sim) {
                    sim.state = { isOn: false };
                    sim.canvas.onclick = () => sim.state.isOn = !sim.state.isOn;

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Bulb
                        ctx.fillStyle = sim.state.isOn ? '#f1c40f' : '#34495e';
                        ctx.beginPath(); ctx.arc(300, 150, 60, 0, Math.PI*2); ctx.fill();
                        if(sim.state.isOn) {
                            ctx.shadowBlur = 50; ctx.shadowColor = '#f1c40f'; ctx.stroke(); ctx.shadowBlur = 0;
                        }
                        
                        // Base
                        ctx.fillStyle = '#7f8c8d'; ctx.fillRect(280, 210, 40, 40);

                        // Text
                        ctx.fillStyle = '#000'; ctx.font = 'bold 30px monospace'; ctx.textAlign = 'center';
                        ctx.fillText(sim.state.isOn ? "True" : "False", 300, 300);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 8. COMPARISONS
            comparison: {
                init: function(sim) {
                    sim.state = { left: 5, right: 5 };
                    document.getElementById('sim-controls').innerHTML = `
                        <div class="flex gap-4 w-full justify-center">
                            <div class="text-center">
                                <label class="block font-bold text-py-blue">Left Weight</label>
                                <input type="range" min="1" max="10" value="5" oninput="Simulations.state.left=parseInt(this.value)">
                                <div id="comp-l-val">5</div>
                            </div>
                            <div class="text-center">
                                <label class="block font-bold text-red-600">Right Weight</label>
                                <input type="range" min="1" max="10" value="5" oninput="Simulations.state.right=parseInt(this.value)">
                                <div id="comp-r-val">5</div>
                            </div>
                        </div>
                    `;

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        const l = sim.state.left;
                        const r = sim.state.right;
                        
                        // Update labels
                        const lVal = document.getElementById('comp-l-val');
                        const rVal = document.getElementById('comp-r-val');
                        if(lVal) lVal.textContent = l;
                        if(rVal) rVal.textContent = r;

                        // Calculate tilt
                        let angle = 0;
                        if (l > r) angle = -0.2;
                        else if (r > l) angle = 0.2;
                        
                        // Draw Scale
                        ctx.save();
                        ctx.translate(300, 200);
                        
                        // Base
                        ctx.fillStyle = '#7f8c8d';
                        ctx.fillRect(-10, 0, 20, 100);
                        ctx.beginPath(); ctx.moveTo(-30, 100); ctx.lineTo(30, 100); ctx.lineTo(0, 0); ctx.fill();

                        // Beam
                        ctx.rotate(angle);
                        ctx.fillStyle = '#95a5a6';
                        ctx.fillRect(-150, -5, 300, 10);
                        
                        // Plates
                        ctx.strokeStyle = '#34495e'; ctx.lineWidth = 2;
                        // Left Plate
                        ctx.beginPath(); ctx.moveTo(-140, 0); ctx.lineTo(-140, 50); ctx.stroke();
                        ctx.fillStyle = '#ecf0f1'; ctx.beginPath(); ctx.arc(-140, 60, 30, 0, Math.PI, false); ctx.fill(); ctx.stroke();
                        // Right Plate
                        ctx.beginPath(); ctx.moveTo(140, 0); ctx.lineTo(140, 50); ctx.stroke();
                        ctx.fillStyle = '#ecf0f1'; ctx.beginPath(); ctx.arc(140, 60, 30, 0, Math.PI, false); ctx.fill(); ctx.stroke();

                        // Weights
                        ctx.fillStyle = '#306998';
                        ctx.beginPath(); ctx.arc(-140, 60 - (l*2), l*3, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#fff'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(l, -140, 65 - (l*2));

                        ctx.fillStyle = '#e74c3c';
                        ctx.beginPath(); ctx.arc(140, 60 - (r*2), r*3, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#fff'; ctx.fillText(r, 140, 65 - (r*2));

                        ctx.restore();

                        // Comparison Text
                        ctx.fillStyle = '#000'; ctx.font = 'bold 24px monospace'; ctx.textAlign = 'center';
                        let comp = "==";
                        if (l > r) { comp = ">"; }
                        else if (l < r) { comp = "<"; }
                        
                        ctx.fillText(`${l} ${comp} ${r}`, 300, 80);
                        
                        // Feedback
                        if (l == r) {
                            document.getElementById('sim-feedback').textContent = "Equal weights balance the scale.";
                            document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-green-600 min-h-[1.5rem]";
                        } else {
                            document.getElementById('sim-feedback').textContent = "Unequal weights tilt the scale.";
                            document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-brand-dark min-h-[1.5rem]";
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 9. IF STATEMENT
            if_statement: {
                init: function(sim) {
                    sim.state = { condition: false, charX: 50, gateGap: 0 };
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-purple-600 text-white rounded font-bold";
                    btn.textContent = "Toggle Condition";
                    btn.onclick = () => sim.state.condition = !sim.state.condition;
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Path
                        ctx.fillStyle = '#ecf0f1'; ctx.fillRect(0, 200, 600, 50);
                        
                        // Update Gate Gap
                        if (sim.state.condition && sim.state.gateGap < 40) sim.state.gateGap += 2;
                        if (!sim.state.condition && sim.state.gateGap > 0) sim.state.gateGap -= 2;

                        // Gate (2 Rectangles)
                        ctx.fillStyle = sim.state.condition ? '#2ecc71' : '#e74c3c';
                        // Top part
                        ctx.fillRect(300, 150 - sim.state.gateGap, 20, 75);
                        // Bottom part
                        ctx.fillRect(300, 225 + sim.state.gateGap, 20, 75);
                        
                        // Character
                        if((sim.state.condition && sim.state.gateGap >= 30) || sim.state.charX < 280) {
                            sim.state.charX += 2;
                        }
                        if(sim.state.charX > 600) sim.state.charX = 0;

                        ctx.fillStyle = '#3498db';
                        ctx.beginPath(); ctx.arc(sim.state.charX, 225, 15, 0, Math.PI*2); ctx.fill();

                        // Code
                        ctx.fillStyle = '#000'; ctx.font = '16px monospace'; ctx.textAlign = 'center';
                        ctx.fillText(`gate_open = ${sim.state.condition ? 'True' : 'False'}`, 300, 40);
                        ctx.fillText("if gate_open:", 300, 65);
                        
                        if (sim.state.condition) {
                            ctx.fillStyle = '#2ecc71';
                            ctx.fillText("    move()", 300, 85);
                        } else {
                            ctx.fillStyle = '#95a5a6';
                            ctx.fillText("    move()", 300, 85);
                            ctx.fillStyle = '#e74c3c';
                            ctx.fillText("else:", 300, 105);
                            ctx.fillText("    stop()", 300, 125);
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 10. ELSE STATEMENT
            else_statement: {
                init: function(sim) {
                    sim.state = { path: 'forest', charX: 50 };
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-blue-600 text-white rounded font-bold";
                    btn.textContent = "Toggle Path";
                    btn.onclick = () => sim.state.path = sim.state.path === 'forest' ? 'cave' : 'forest';
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Fork
                        ctx.fillStyle = '#ecf0f1'; 
                        ctx.fillRect(0, 150, 300, 50); // Main
                        ctx.beginPath(); ctx.moveTo(300, 150); ctx.lineTo(600, 50); ctx.lineTo(600, 100); ctx.lineTo(300, 200); ctx.fill(); // Top (Forest)
                        ctx.beginPath(); ctx.moveTo(300, 150); ctx.lineTo(600, 250); ctx.lineTo(600, 300); ctx.lineTo(300, 200); ctx.fill(); // Bottom (Cave)

                        // Labels
                        ctx.fillStyle = '#27ae60'; ctx.font = 'bold 20px sans-serif'; ctx.textAlign = 'center'; ctx.fillText("Forest", 500, 80);
                        ctx.fillStyle = '#8e44ad'; ctx.fillText("Cave", 500, 280);

                        // Character
                        sim.state.charX += 2;
                        if(sim.state.charX > 600) sim.state.charX = 0;
                        
                        let charY = 175;
                        if (sim.state.charX > 300) {
                            if (sim.state.path === 'forest') charY = 175 - (sim.state.charX - 300) * 0.33;
                            else charY = 175 + (sim.state.charX - 300) * 0.33;
                        }

                        ctx.fillStyle = '#e74c3c';
                        ctx.beginPath(); ctx.arc(sim.state.charX, charY, 15, 0, Math.PI*2); ctx.fill();

                        // Code
                        ctx.fillStyle = '#000'; ctx.font = '16px monospace'; ctx.textAlign = 'left';
                        ctx.fillText(`path = '${sim.state.path}'`, 20, 40);
                        ctx.fillText("if path == 'forest':", 20, 65);
                        ctx.fillStyle = sim.state.path === 'forest' ? '#2ecc71' : '#95a5a6';
                        ctx.fillText("    go_forest()", 40, 85);
                        ctx.fillStyle = '#000';
                        ctx.fillText("else:", 20, 105);
                        ctx.fillStyle = sim.state.path === 'cave' ? '#2ecc71' : '#95a5a6';
                        ctx.fillText("    go_cave()", 40, 125);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 11. LISTS
            lists: {
                init: function(sim) {
                    sim.state = { items: [] };
                    const btn = document.createElement('button');
                    btn.className = "ml-2 px-4 py-2 bg-blue-600 text-white rounded font-bold";
                    btn.textContent = "Add Item";
                    btn.onclick = () => {
                        if(sim.state.items.length < 5) sim.state.items.push(Math.floor(Math.random()*100));
                    };
                    document.getElementById('sim-controls').appendChild(btn);
                    
                    const btn2 = document.createElement('button');
                    btn2.className = "ml-2 px-4 py-2 bg-red-600 text-white rounded font-bold";
                    btn2.textContent = "Pop Item";
                    btn2.onclick = () => sim.state.items.pop();
                    document.getElementById('sim-controls').appendChild(btn2);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // List Brackets
                        ctx.fillStyle = '#000'; ctx.font = 'bold 60px monospace'; ctx.textAlign = 'left';
                        ctx.fillText("[", 50, 200);
                        ctx.fillText("]", 50 + (sim.state.items.length * 80) + 20, 200);

                        // Items
                        sim.state.items.forEach((item, i) => {
                            ctx.fillStyle = '#f1c40f';
                            ctx.fillRect(80 + i*80, 150, 60, 60);
                            ctx.fillStyle = '#000'; ctx.font = '20px monospace'; ctx.textAlign = 'center';
                            ctx.fillText(item, 110 + i*80, 190);
                            
                            // Index
                            ctx.fillStyle = '#7f8c8d'; ctx.font = '14px monospace';
                            ctx.fillText(i, 110 + i*80, 230);
                        });

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 12. INDEXING
            indexing: {
                init: function(sim) {
                    sim.state = { selected: null };
                    const items = ["Red Potion", "Blue Potion", "Green Potion", "Yellow Potion"];
                    const colors = ["#ef4444", "#3b82f6", "#22c55e", "#eab308"];
                    
                    const container = document.getElementById('sim-controls');
                    
                    // Create buttons for indices
                    const btnContainer = document.createElement('div');
                    btnContainer.className = "flex gap-2 justify-center";
                    
                    items.forEach((item, i) => {
                        const btn = document.createElement('button');
                        btn.className = "px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded font-bold font-mono";
                        btn.textContent = `[${i}]`;
                        btn.onclick = () => {
                            sim.state.selected = i;
                            document.getElementById('sim-feedback').textContent = `inventory[${i}] == '${item}'`;
                            document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-py-blue min-h-[1.5rem]";
                        };
                        btnContainer.appendChild(btn);
                    });
                    container.appendChild(btnContainer);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Draw Shelf
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(50, 250, 500, 20);

                        // Draw Items
                        items.forEach((item, i) => {
                            const x = 110 + i * 120;
                            const y = 200;
                            
                            // Highlight selection
                            if (sim.state.selected === i) {
                                ctx.fillStyle = 'rgba(255, 212, 59, 0.3)'; // py-yellow transparent
                                ctx.fillRect(x - 50, y - 60, 100, 120);
                                ctx.strokeStyle = '#FFD43B';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(x - 50, y - 60, 100, 120);
                            }

                            // Potion Bottle
                            ctx.fillStyle = colors[i];
                            ctx.beginPath(); 
                            ctx.arc(x, y + 20, 25, 0, Math.PI*2); 
                            ctx.fill();
                            ctx.fillRect(x - 10, y - 30, 20, 50); // Neck
                            ctx.fillStyle = '#fff'; // Cork/Highlight
                            ctx.fillRect(x - 12, y - 35, 24, 10);

                            // Index Label
                            ctx.fillStyle = '#000';
                            ctx.font = 'bold 20px monospace';
                            ctx.textAlign = 'center';
                            ctx.fillText(i, x, 300);
                        });
                        
                        ctx.fillStyle = '#000';
                        ctx.font = '16px sans-serif';
                        ctx.fillText("Indices start at 0!", 300, 330);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 13. FOR LOOP
            for_loop: {
                init: function(sim) {
                    sim.state = { idx: 0, t: 0 };
                    sim.state = { idx: 0, t: 0, running: false };
                    const islands = [100, 200, 300, 400, 500];

                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-green-600 text-white rounded font-bold";
                    btn.textContent = "Start Loop";
                    btn.onclick = () => {
                        sim.state.running = true;
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    };
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        if(sim.state.running) sim.state.t += 0.05;
                        
                        // Islands
                        islands.forEach((x, i) => {
                            ctx.fillStyle = i === Math.floor(sim.state.idx) ? '#2ecc71' : '#95a5a6';
                            ctx.beginPath(); ctx.arc(x, 250, 30, 0, Math.PI*2); ctx.fill();
                            ctx.fillStyle = '#fff'; ctx.font = '16px monospace'; ctx.textAlign = 'center';
                            ctx.fillText(i, x, 255);
                        });

                        // Character
                        const currentX = islands[Math.floor(sim.state.idx)];
                        ctx.fillStyle = '#e74c3c';
                        ctx.beginPath(); ctx.arc(currentX, 200 + Math.sin(sim.state.t*5)*10, 15, 0, Math.PI*2); ctx.fill();

                        // Logic
                        if(sim.state.t > 2) {
                            sim.state.t = 0;
                            sim.state.idx = (sim.state.idx + 1) % islands.length;
                        }

                        ctx.fillStyle = '#000'; ctx.font = '20px monospace';
                        ctx.fillText(`for i in islands: visit(island[${Math.floor(sim.state.idx)}])`, 300, 100);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 14. RANGE
            range: {
                init: function(sim) {
                    sim.state = { n: 5 };
                    document.getElementById('sim-controls').innerHTML = `
                        <div class="flex flex-col items-center w-full">
                            <label class="font-bold text-gray-700 mb-2 font-mono">range(<span id="rng-val">5</span>)</label>
                            <input type="range" min="1" max="10" value="5" class="w-full max-w-xs" oninput="Simulations.state.n=parseInt(this.value); document.getElementById('rng-val').textContent=this.value;">
                        </div>
                    `;

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        const n = sim.state.n;
                        const startX = 50;
                        const spacing = 500 / Math.max(n, 1);
                        
                        ctx.font = '20px monospace';
                        ctx.textAlign = 'center';

                        // Draw generated numbers
                        for(let i=0; i<n; i++) {
                            const x = startX + i * spacing + spacing/2;
                            const y = 175;
                            
                            // Box
                            ctx.fillStyle = '#306998';
                            ctx.fillRect(x - 20, y - 20, 40, 40);
                            
                            // Number
                            ctx.fillStyle = '#fff';
                            ctx.fillText(i, x, y + 7);
                            
                            // Connection line
                            if (i < n - 1) {
                                ctx.strokeStyle = '#FFD43B';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(x + 20, y);
                                ctx.lineTo(x + spacing - 20, y);
                                ctx.stroke();
                            }
                        }

                        // Code display
                        ctx.fillStyle = '#000';
                        ctx.font = '24px monospace';
                        ctx.fillText(`list(range(${n}))`, 300, 80);
                        
                        ctx.fillStyle = '#555';
                        ctx.font = '18px monospace';
                        const result = Array.from({length: n}, (_, i) => i).join(', ');
                        ctx.fillText(`[${result}]`, 300, 280);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 15. WHILE LOOP
            while_loop: {
                init: function(sim) {
                    sim.state = { level: 0 };
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-blue-600 text-white rounded font-bold";
                    btn.textContent = "Reset Bucket";
                    btn.onclick = () => sim.state.level = 0;
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Bucket
                        ctx.strokeStyle = '#34495e'; ctx.lineWidth = 5;
                        ctx.strokeRect(250, 190, 100, 150);
                        
                        // Water
                        if(sim.state.level < 150) {
                            sim.state.level += 1;
                            // Flowing water
                            ctx.fillStyle = '#3498db';
                            ctx.fillRect(290, 90, 20, 250 - sim.state.level);
                        }
                        
                        ctx.fillStyle = '#3498db';
                        ctx.fillRect(250, 340 - sim.state.level, 100, sim.state.level);

                        // Code
                        ctx.fillStyle = '#000'; ctx.font = '16px monospace'; ctx.textAlign = 'center';
                        ctx.fillText("while bucket_full == False:", 300, 50);
                        ctx.fillText("    add_water()", 300, 70);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 16. FUNCTIONS
            functions: {
                init: function(sim) {
                    sim.state = { spells: [] };
                    
                    const createBtn = (name, color) => {
                        const btn = document.createElement('button');
                        btn.className = `px-3 py-2 m-1 text-white rounded font-bold shadow hover:opacity-90`;
                        btn.style.backgroundColor = color;
                        btn.textContent = `${name}()`;
                        btn.onclick = () => {
                            sim.state.spells.push({ type: name, x: 90, y: 200, t: 0, color: color });
                            document.getElementById('sim-feedback').textContent = `Executed: ${name}()`;
                        };
                        document.getElementById('sim-controls').appendChild(btn);
                    };

                    createBtn('fireball', '#e74c3c');
                    createBtn('heal', '#2ecc71');
                    createBtn('shield', '#3498db');

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Wizard
                        ctx.fillStyle = '#8e44ad'; 
                        ctx.fillRect(50, 200, 40, 80); // Body
                        ctx.beginPath(); ctx.arc(70, 190, 20, 0, Math.PI*2); ctx.fill(); // Head
                        ctx.fillStyle = '#5e3370'; // Hat
                        ctx.beginPath(); ctx.moveTo(50, 180); ctx.lineTo(90, 180); ctx.lineTo(70, 130); ctx.fill();

                        // Spells
                        for (let i = sim.state.spells.length - 1; i >= 0; i--) {
                            let s = sim.state.spells[i];
                            s.t++;
                            
                            if (s.type === 'fireball') {
                                s.x += 8;
                                ctx.fillStyle = s.color;
                                ctx.beginPath(); ctx.arc(s.x, s.y, 10, 0, Math.PI*2); ctx.fill();
                                if (s.x > 650) sim.state.spells.splice(i, 1);
                            } else if (s.type === 'heal') {
                                s.y -= 2;
                                ctx.fillStyle = s.color;
                                ctx.font = "24px sans-serif";
                                ctx.fillText("‚úö", 70, s.y);
                                if (s.t > 50) sim.state.spells.splice(i, 1);
                            } else if (s.type === 'shield') {
                                ctx.strokeStyle = s.color;
                                ctx.lineWidth = 4;
                                ctx.beginPath(); ctx.arc(70, 240, 50, Math.PI, 0); ctx.stroke();
                                if (s.t > 50) sim.state.spells.splice(i, 1);
                            }
                        }

                        // Code Block
                        ctx.fillStyle = '#000'; ctx.font = '16px monospace'; ctx.textAlign = 'left';
                        ctx.fillText("def fireball(): attack()", 350, 50);
                        ctx.fillText("def heal(): recover()", 350, 75);
                        ctx.fillText("def shield(): protect()", 350, 100);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 17. PARAMETERS
            parameters: {
                init: function(sim) {
                    sim.state = { color: '#bdc3c7', name: 'None', bubbles: [] };
                    const controls = document.getElementById('sim-controls');
                    
                    const ingredients = [
                        { name: "'frog_leg'", label: "Frog Leg", color: "#2ecc71" },
                        { name: "'bat_wing'", label: "Bat Wing", color: "#9b59b6" },
                        { name: "'fire_dust'", label: "Fire Dust", color: "#e74c3c" }
                    ];

                    ingredients.forEach(ing => {
                        const btn = document.createElement('button');
                        btn.className = "px-3 py-1 m-1 text-white rounded font-bold shadow-sm hover:opacity-90";
                        btn.style.backgroundColor = ing.color;
                        btn.textContent = ing.label;
                        btn.onclick = () => {
                            sim.state.color = ing.color;
                            sim.state.name = ing.name;
                            // Add bubbles
                            for(let i=0; i<5; i++) sim.state.bubbles.push({x: 300 + (Math.random()-0.5)*40, y: 220, r: Math.random()*5+2, s: Math.random()+1});
                        };
                        controls.appendChild(btn);
                    });

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Cauldron
                        ctx.fillStyle = '#34495e';
                        ctx.beginPath(); ctx.arc(300, 250, 60, 0, Math.PI*2); ctx.fill(); // Bowl
                        ctx.fillRect(240, 200, 120, 50); // Top
                        
                        // Liquid
                        ctx.fillStyle = sim.state.color;
                        ctx.beginPath(); ctx.ellipse(300, 210, 50, 8, 0, 0, Math.PI*2); ctx.fill();
                        
                        // Bubbles
                        for(let i=sim.state.bubbles.length-1; i>=0; i--) {
                            let b = sim.state.bubbles[i];
                            b.y -= b.s;
                            ctx.fillStyle = sim.state.color;
                            ctx.globalAlpha = 0.7;
                            ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
                            ctx.globalAlpha = 1.0;
                            if(b.y < 150) sim.state.bubbles.splice(i, 1);
                        }

                        // Rim front (to cover liquid)
                        ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 2;
                        ctx.beginPath(); ctx.ellipse(300, 200, 60, 10, 0, 0, Math.PI*2); ctx.stroke();

                        // Code
                        ctx.fillStyle = '#000'; ctx.font = '20px monospace'; ctx.textAlign = 'center';
                        if (sim.state.name !== 'None') {
                            ctx.fillText(`brew_potion(${sim.state.name})`, 300, 100);
                        } else {
                            ctx.fillText(`brew_potion(...)`, 300, 100);
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 18. RETURN
            return: {
                init: function(sim) {
                    sim.state = { phase: 'idle', bx: 50, gold: false };
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-yellow-500 text-white rounded font-bold shadow-lg hover:bg-yellow-600";
                    btn.textContent = "Get Gold";
                    btn.onclick = () => { if(sim.state.phase === 'idle') sim.state.phase = 'out'; };
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Hero & Chest
                        ctx.fillStyle = '#34495e'; ctx.fillRect(20, 200, 30, 60);
                        ctx.fillStyle = '#d35400'; ctx.fillRect(500, 220, 60, 40);
                        
                        // Logic
                        if(sim.state.phase === 'out') {
                            sim.state.bx += 15;
                            if(sim.state.bx >= 500) { sim.state.phase = 'back'; sim.state.gold = true; }
                        } else if(sim.state.phase === 'back') {
                            sim.state.bx -= 15;
                            if(sim.state.bx <= 50) { sim.state.phase = 'idle'; document.getElementById('sim-feedback').textContent = "Returned: 100 Gold"; }
                        }

                        // Boomerang
                        ctx.save(); ctx.translate(sim.state.bx, 220); ctx.rotate(Date.now()/50);
                        ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.ellipse(0, 0, 20, 5, 0, 0, Math.PI*2); ctx.fill();
                        if(sim.state.gold && sim.state.phase !== 'idle') { ctx.fillStyle='#fff'; ctx.fillText("üí∞", -10, 5); }
                        ctx.restore();

                        // Code
                        ctx.fillStyle = '#000'; ctx.font = '18px monospace'; ctx.textAlign = 'center';
                        ctx.fillText("def get_loot(): return 100", 300, 50);
                        if(sim.state.phase === 'idle' && sim.state.gold) ctx.fillText("my_gold = 100", 300, 100);

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 19. DICTIONARIES
            dictionaries: {
                init: function(sim) {
                    sim.state = { key: '' };
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = "Enter Key (apple, banana)";
                    input.className = "p-2 border rounded mr-2";
                    
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-green-600 text-white rounded font-bold";
                    btn.textContent = "Lookup";
                    btn.onclick = () => sim.state.key = input.value.toLowerCase();
                    
                    const container = document.getElementById('sim-controls');
                    container.appendChild(input);
                    container.appendChild(btn);

                    const data = { 'apple': 'üî¥', 'banana': 'üçå', 'grape': 'üçá' };

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Draw Dictionary
                        ctx.fillStyle = '#34495e'; ctx.fillRect(100, 100, 400, 150);
                        ctx.fillStyle = '#fff'; ctx.font = '20px monospace'; ctx.textAlign = 'center';
                        ctx.fillText("{ 'apple': 'üî¥', 'banana': 'üçå' }", 300, 180);

                        // Result
                        const val = data[sim.state.key];
                        if(val) {
                            ctx.font = '60px serif';
                            ctx.fillText(val, 300, 320);
                            document.getElementById('sim-feedback').textContent = `Found value for key '${sim.state.key}'`;
                        } else if (sim.state.key) {
                            ctx.font = '20px sans-serif'; ctx.fillStyle = '#e74c3c';
                            ctx.fillText("KeyError", 300, 320);
                            document.getElementById('sim-feedback').textContent = "Key not found.";
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 20. MODULES
            modules: {
                init: function(sim) {
                    sim.state = { imported: false, dieValue: null };
                    const btnImport = document.createElement('button');
                    btnImport.className = "px-4 py-2 bg-purple-600 text-white rounded font-bold mr-2";
                    btnImport.textContent = "import random";
                    btnImport.onclick = () => {
                        sim.state.imported = true;
                        btnImport.disabled = true;
                        btnImport.classList.add('opacity-50', 'cursor-not-allowed');
                        renderRollButton();
                    };
                    document.getElementById('sim-controls').appendChild(btnImport);

                    function renderRollButton() {
                        const btnRoll = document.createElement('button');
                        btnRoll.className = "px-4 py-2 bg-green-600 text-white rounded font-bold";
                        btnRoll.textContent = "random.randint(1, 6)";
                        btnRoll.onclick = () => {
                            let rolls = 0;
                            const interval = setInterval(() => {
                                sim.state.dieValue = Math.floor(Math.random() * 6) + 1;
                                rolls++;
                                if (rolls > 10) {
                                    clearInterval(interval);
                                    document.getElementById('sim-feedback').textContent = `Rolled: ${sim.state.dieValue}`;
                                }
                            }, 50);
                        };
                        document.getElementById('sim-controls').appendChild(btnRoll);
                    }

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Library Shelf
                        ctx.fillStyle = '#5D4037'; ctx.fillRect(50, 50, 500, 250);
                        ctx.fillStyle = '#8B4513'; ctx.fillRect(60, 60, 480, 230);
                        ctx.fillStyle = '#A0522D'; ctx.fillRect(60, 130, 480, 10); ctx.fillRect(60, 210, 480, 10);

                        // Books
                        const books = ['math', 'time', 'os', 'sys', 'json'];
                        books.forEach((b, i) => {
                            ctx.fillStyle = `hsl(${i * 60}, 60%, 40%)`;
                            ctx.fillRect(80 + i*40, 70, 30, 60);
                            ctx.fillStyle = '#fff'; ctx.font = '10px monospace';
                            ctx.save(); ctx.translate(95 + i*40, 120); ctx.rotate(-Math.PI/2);
                            ctx.fillText(b, 0, 0); ctx.restore();
                        });

                        if (sim.state.imported) {
                            ctx.fillStyle = '#8e44ad'; ctx.fillRect(300, 180, 60, 80);
                            ctx.fillStyle = '#fff'; ctx.font = '12px monospace'; ctx.textAlign = 'center';
                            ctx.fillText("random", 330, 220);
                            
                            if (sim.state.dieValue !== null) {
                                ctx.fillStyle = '#fff'; ctx.fillRect(400, 180, 60, 60);
                                ctx.strokeRect(400, 180, 60, 60);
                                ctx.fillStyle = '#000'; ctx.font = '40px sans-serif';
                                ctx.fillText(sim.state.dieValue, 430, 225);
                            }
                        }
                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 21. CLASSES
            classes: {
                init: function(sim) {
                    sim.state = { robots: [] };
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-gray-600 text-white rounded font-bold";
                    btn.textContent = "robot = Robot()";
                    btn.onclick = () => {
                        if(sim.state.robots.length < 5) {
                            sim.state.robots.push({x: 50 + sim.state.robots.length * 100, color: '#95a5a6'});
                        }
                    };
                    document.getElementById('sim-controls').appendChild(btn);

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Blueprint
                        ctx.strokeStyle = '#3498db'; ctx.lineWidth = 2; ctx.setLineDash([5,5]);
                        ctx.strokeRect(250, 20, 100, 100);
                        ctx.fillStyle = '#3498db'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
                        ctx.fillText("Class Robot", 300, 75);
                        ctx.setLineDash([]);

                        // Instances
                        sim.state.robots.forEach(r => {
                            ctx.fillStyle = r.color;
                            ctx.fillRect(r.x, 200, 60, 80); // Body
                            ctx.fillRect(r.x + 15, 170, 30, 30); // Head
                            ctx.fillStyle = '#000';
                            ctx.beginPath(); ctx.arc(r.x + 25, 185, 3, 0, Math.PI*2); ctx.fill();
                            ctx.beginPath(); ctx.arc(r.x + 35, 185, 3, 0, Math.PI*2); ctx.fill();
                        });

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 22. OBJECTS
            objects: {
                init: function(sim) {
                    sim.state = { robots: [] };
                    const colors = ['red', 'blue', 'green', 'purple'];
                    
                    colors.forEach(color => {
                        const btn = document.createElement('button');
                        btn.className = `px-3 py-1 m-1 text-white rounded font-bold capitalize shadow-sm hover:opacity-90`;
                        btn.style.backgroundColor = color === 'red' ? '#ef4444' : (color === 'blue' ? '#3b82f6' : (color === 'green' ? '#22c55e' : '#a855f7'));
                        btn.textContent = `Robot('${color}')`;
                        btn.onclick = () => {
                            if(sim.state.robots.length < 8) {
                                sim.state.robots.push({
                                    x: 50 + Math.random() * 500,
                                    y: 200 + Math.random() * 50,
                                    color: btn.style.backgroundColor,
                                    scale: 0.5 + Math.random() * 0.5,
                                    speed: (Math.random() - 0.5) * 2
                                });
                            }
                            if (sim.state.robots.length >= 8) {
                                const buttons = document.getElementById('sim-controls').querySelectorAll('button');
                                buttons.forEach(b => {
                                    b.disabled = true;
                                    b.classList.add('opacity-50', 'cursor-not-allowed');
                                });
                            }
                        };
                        document.getElementById('sim-controls').appendChild(btn);
                    });

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        ctx.fillStyle = '#bdc3c7'; ctx.fillRect(0, 250, 600, 100);
                        
                        sim.state.robots.forEach(r => {
                            r.x += r.speed;
                            if(r.x < 20 || r.x > 580) r.speed *= -1;

                            ctx.save();
                            ctx.translate(r.x, r.y);
                            ctx.scale(r.scale, r.scale);
                            
                            ctx.fillStyle = r.color; ctx.fillRect(-20, -40, 40, 60);
                            ctx.fillStyle = '#95a5a6'; ctx.fillRect(-15, -60, 30, 20);
                            
                            ctx.fillStyle = '#fff';
                            ctx.beginPath(); ctx.arc(-7, -50, 5, 0, Math.PI*2); ctx.fill();
                            ctx.beginPath(); ctx.arc(7, -50, 5, 0, Math.PI*2); ctx.fill();
                            ctx.fillStyle = '#000';
                            ctx.beginPath(); ctx.arc(-7, -50, 2, 0, Math.PI*2); ctx.fill();
                            ctx.beginPath(); ctx.arc(7, -50, 2, 0, Math.PI*2); ctx.fill();
                            
                            ctx.strokeStyle = '#7f8c8d'; ctx.lineWidth = 5;
                            ctx.beginPath(); ctx.moveTo(-20, -30); ctx.lineTo(-35, -10); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(20, -30); ctx.lineTo(35, -10); ctx.stroke();
                            
                            ctx.fillStyle = '#7f8c8d';
                            ctx.fillRect(-15, 20, 10, 30); ctx.fillRect(5, 20, 10, 30);

                            ctx.restore();
                        });

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 23. DEBUGGING
            debugging: {
                init: function(sim) {
                    sim.state = { fixed: false, bug: {x: 0, y: 0, t: 0} };
                    
                    sim.canvas.onclick = (e) => {
                        const rect = sim.canvas.getBoundingClientRect();
                        const mx = e.clientX - rect.left;
                        const my = e.clientY - rect.top;
                        
                        const dx = mx - sim.state.bug.x;
                        const dy = my - sim.state.bug.y;
                        if (!sim.state.fixed && Math.sqrt(dx*dx + dy*dy) < 30) {
                            sim.state.fixed = true;
                            document.getElementById('sim-feedback').textContent = "Bug Squashed! Syntax Error Fixed.";
                            document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-green-600 min-h-[1.5rem]";
                        }
                    };

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0,0,600,350);
                        
                        // Editor Window
                        ctx.fillStyle = '#282c34'; ctx.fillRect(50, 20, 500, 200);
                        
                        // Line numbers
                        ctx.fillStyle = '#4b5263'; ctx.font = '20px monospace'; ctx.textAlign = 'right';
                        ctx.fillText("1", 80, 60);
                        ctx.fillText("2", 80, 90);
                        ctx.fillText("3", 80, 120);
                        
                        // Code
                        ctx.textAlign = 'left';
                        ctx.fillStyle = '#c678dd'; ctx.fillText("def", 100, 60);
                        ctx.fillStyle = '#61afef'; ctx.fillText("greet", 140, 60);
                        ctx.fillStyle = '#abb2bf'; ctx.fillText("(name)", 200, 60);
                        
                        if (sim.state.fixed) {
                            ctx.fillStyle = '#abb2bf'; ctx.fillText(":", 270, 60);
                        }
                        
                        ctx.fillStyle = '#e06c75'; ctx.fillText("print", 140, 90); 
                        ctx.fillStyle = '#abb2bf'; ctx.fillText("(", 200, 90);
                        ctx.fillStyle = '#98c379'; ctx.fillText("'Hello '", 210, 90);
                        ctx.fillStyle = '#abb2bf'; ctx.fillText("+ name)", 300, 90);

                        ctx.fillStyle = '#61afef'; ctx.fillText("greet", 100, 120);
                        ctx.fillStyle = '#abb2bf'; ctx.fillText("('Alex')", 160, 120);

                        // Console/Error Output
                        ctx.fillStyle = '#1e293b'; ctx.fillRect(50, 230, 500, 100);
                        ctx.font = '14px monospace';
                        
                        if (!sim.state.fixed) {
                            // Error Message
                            ctx.fillStyle = '#e06c75';
                            ctx.fillText("SyntaxError: expected ':'", 60, 260);
                            ctx.fillText("  Line 1: def greet(name)", 60, 280);
                            ctx.strokeStyle = '#e06c75'; ctx.lineWidth = 2;
                            ctx.beginPath(); 
                            ctx.moveTo(270, 65); 
                            for(let i=0; i<10; i++) ctx.lineTo(270+i*2, 65 + (i%2==0?2:-2));
                            ctx.stroke();

                            // Draw Bug
                            sim.state.bug.t += 0.1;
                            const bx = 280 + Math.sin(sim.state.bug.t)*10;
                            const by = 55 + Math.cos(sim.state.bug.t*0.7)*10;
                            sim.state.bug.x = bx; sim.state.bug.y = by;

                            ctx.fillStyle = '#e74c3c';
                            ctx.beginPath(); ctx.arc(bx, by, 8, 0, Math.PI*2); ctx.fill(); 
                            ctx.strokeStyle = '#000'; ctx.lineWidth = 1;
                            for(let i=0; i<3; i++) {
                                ctx.beginPath(); ctx.moveTo(bx-5, by-5+i*5); ctx.lineTo(bx-12, by-8+i*5 + Math.sin(sim.state.bug.t*2)*2); ctx.stroke();
                                ctx.beginPath(); ctx.moveTo(bx+5, by-5+i*5); ctx.lineTo(bx+12, by-8+i*5 + Math.cos(sim.state.bug.t*2)*2); ctx.stroke();
                            }
                            
                            ctx.fillStyle = '#fff'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
                            ctx.fillText("Click the bug!", bx, by - 15);
                        } else {
                            // Success Output
                            ctx.fillStyle = '#98c379';
                            ctx.fillText("> Hello Alex", 60, 260);
                            ctx.fillStyle = '#fff';
                            ctx.fillText("Program exited with code 0", 60, 280);
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                }
            },

            // 24. DRAG & DROP CODE
            drag_drop_code: {
                blocks: [],
                dragging: null,
                offset: {x:0, y:0},
                isCorrect: false,
                currentChallenge: 0,
                challenges: [
                    { goal: "print('Python')", blocks: ["print", "(", "'Python'", ")"] },
                    { goal: "x = 10", blocks: ["x", "=", "10"] },
                    { goal: "y = x + 5", blocks: ["y", "=", "x", "+", "5"] },
                    { goal: "if True:", blocks: ["if", "True", ":"] },
                    { goal: "while x > 0:", blocks: ["while", "x", ">", "0", ":"] },
                    { goal: "for i in range(5):", blocks: ["for", "i", "in", "range", "(", "5", ")", ":"] },
                    { goal: "L = [1, 2, 3]", blocks: ["L", "=", "[", "1", ",", "2", ",", "3", "]"] },
                    { goal: "def func():", blocks: ["def", "func", "(", ")", ":"] },
                    { goal: "return x * 2", blocks: ["return", "x", "*", "2"] },
                    { goal: "import math", blocks: ["import", "math"] }
                ],
                
                init: function(sim) {
                    this.isCorrect = false;
                    this.solvedChallenges = new Set();
                    const texts = ["print", "(", "'Python'", ")"];
                    this.blocks = texts.map((t, i) => ({
                        text: t,
                        x: 50 + i * 120,
                        y: 250,
                        w: t.length * 14 + 20,
                        h: 40,
                        inCodeArea: false,
                        correct: false
                    }));
                    // Shuffle positions
                    this.blocks.sort(() => Math.random() - 0.5);
                    this.blocks.forEach((b, i) => { b.x = 50 + i * 130; b.y = 250; });
                    this.currentChallenge = 0;

                    // Add Run button
                    const btnRun = document.createElement('button');
                    btnRun.className = "w-full px-4 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 transition mb-2";
                    btnRun.textContent = "Run Code";
                    btnRun.onclick = () => this.check(sim);
                    document.getElementById('sim-controls').appendChild(btnRun);

                    // Add Solve button
                    const btnSolve = document.createElement('button');
                    btnSolve.className = "w-full px-4 py-2 bg-yellow-500 text-white rounded font-bold hover:bg-yellow-600 transition mb-2";
                    btnSolve.textContent = "Solve Challenge";
                    btnSolve.onclick = () => this.solve(sim);
                    document.getElementById('sim-controls').appendChild(btnSolve);

                    // Add More Options button
                    const btnMore = document.createElement('button');
                    btnMore.className = "w-full px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition";
                    btnMore.textContent = "Try More Coding Options";
                    btnMore.onclick = () => {
                        this.currentChallenge = (this.currentChallenge + 1) % this.challenges.length;
                        this.loadChallenge(sim);
                    };
                    document.getElementById('sim-controls').appendChild(btnMore);

                    this.loadChallenge(sim);

                    // Canvas events
                    sim.canvas.onmousedown = (e) => {
                        const rect = sim.canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        for (let i = this.blocks.length - 1; i >= 0; i--) {
                            const b = this.blocks[i];
                            if (x >= b.x && x <= b.x + b.w && y >= b.y && y <= b.y + b.h) {
                                this.dragging = b;
                                this.offset = {x: x - b.x, y: y - b.y};
                                // Move to top of stack
                                this.blocks.splice(i, 1);
                                this.blocks.push(b);
                                b.inCodeArea = false; // Temporarily remove from code area logic
                                this.isCorrect = false; // Reset correctness on drag
                                this.blocks.forEach(bl => bl.correct = false);
                                document.getElementById('sim-feedback').textContent = "Drag blocks into the Code Area and click 'Run Code'.";
                                document.getElementById('sim-feedback').innerHTML = `Goal: <code>${this.challenges[this.currentChallenge].goal}</code>`;
                                document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-brand-dark min-h-[1.5rem]";
                                break;
                            }
                        }
                    };

                    sim.canvas.onmousemove = (e) => {
                        if (this.dragging) {
                            const rect = sim.canvas.getBoundingClientRect();
                            this.dragging.x = e.clientX - rect.left - this.offset.x;
                            this.dragging.y = e.clientY - rect.top - this.offset.y;
                        }
                    };

                    sim.canvas.onmouseup = () => {
                        if (!this.dragging) return;
                        
                        if (this.dragging.y < 150) {
                            this.dragging.inCodeArea = true;
                        } else {
                            this.dragging.inCodeArea = false;
                        }
                        this.dragging = null;
                        this.snapAndOrder();
                    };

                    sim.loop = () => {
                        const ctx = sim.ctx;
                        ctx.clearRect(0, 0, 600, 350);
                        
                        // Zones
                        ctx.fillStyle = '#e2e8f0'; ctx.fillRect(20, 20, 560, 120); // Code Area
                        ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2; ctx.strokeRect(20, 20, 560, 120);
                        ctx.fillStyle = '#94a3b8'; ctx.font = '16px sans-serif'; ctx.textAlign = 'left';
                        if (this.blocks.filter(b => b.inCodeArea).length === 0) {
                            ctx.fillText("// Drag blocks here to build your code", 30, 45);
                        }

                        ctx.fillStyle = '#f8fafc'; ctx.fillRect(20, 200, 560, 130); // Toolbox
                        ctx.strokeRect(20, 200, 560, 130);
                        ctx.fillStyle = '#64748b'; ctx.fillText("Toolbox", 30, 225);

                        // Blocks
                        this.blocks.forEach(b => {
                            ctx.fillStyle = b.correct ? '#27ae60' : '#306998';
                            ctx.fillRect(b.x, b.y, b.w, b.h);
                            ctx.strokeStyle = b.correct ? '#FFD43B' : '#1e293b';
                            ctx.lineWidth = b.correct ? 4 : 2;
                            ctx.strokeRect(b.x, b.y, b.w, b.h);
                            ctx.fillStyle = '#fff'; ctx.font = 'bold 20px monospace'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                            ctx.fillText(b.text, b.x + b.w/2, b.y + b.h/2);
                        });
                        
                        // Console output on success
                        if (this.isCorrect) {
                            ctx.fillStyle = '#1e293b'; ctx.fillRect(20, 150, 560, 40);
                            ctx.fillStyle = '#0f0'; ctx.font = '16px monospace'; ctx.textAlign = 'left';
                            ctx.fillText("> " + this.challenges[this.currentChallenge].goal, 30, 175);
                        }

                        sim.animId = requestAnimationFrame(sim.loop);
                    };
                    sim.loop();
                },

                loadChallenge: function(sim) {
                    this.isCorrect = false;
                    const challenge = this.challenges[this.currentChallenge];
                    const texts = challenge.blocks;
                    
                    document.getElementById('sim-feedback').innerHTML = `Goal: <code>${challenge.goal}</code>`;
                    document.getElementById('sim-feedback').className = "mt-3 text-center font-bold text-brand-dark min-h-[1.5rem]";

                    this.blocks = texts.map((t, i) => ({
                        text: t,
                        x: 0,
                        y: 0,
                        w: t.length * 12 + 20,
                        h: 40,
                        inCodeArea: false,
                        correct: false
                    }));

                    // Shuffle and position
                    this.blocks.sort(() => Math.random() - 0.5);
                    
                    let currentX = 40;
                    let currentY = 240;
                    const canvasWidth = 580;

                    this.blocks.forEach(b => {
                        if (currentX + b.w > canvasWidth) {
                            currentX = 40;
                            currentY += 50;
                        }
                        b.x = currentX;
                        b.y = currentY;
                        currentX += b.w + 10;
                    });
                },

                solve: function(sim) {
                    const challenge = this.challenges[this.currentChallenge];
                    const correctOrder = challenge.blocks;
                    
                    let newBlocks = [];
                    let tempBlocks = [...this.blocks];
                    
                    correctOrder.forEach(text => {
                        const idx = tempBlocks.findIndex(b => b.text === text);
                        if (idx !== -1) {
                            newBlocks.push(tempBlocks[idx]);
                            tempBlocks.splice(idx, 1);
                        }
                    });
                    
                    this.blocks = newBlocks;
                    
                    let currentX = 40;
                    const snapY = 65;
                    this.blocks.forEach(b => {
                        b.inCodeArea = true;
                        b.x = currentX;
                        b.y = snapY;
                        currentX += b.w + 10;
                    });
                    
                    this.check(sim);
                },

                snapAndOrder: function() {
                    const codeAreaBlocks = this.blocks.filter(b => b.inCodeArea);
                    codeAreaBlocks.sort((a, b) => a.x - b.x);
                    
                    let currentX = 40;
                    const snapY = 65;
                    codeAreaBlocks.forEach(b => {
                        b.x = currentX;
                        b.y = snapY;
                        currentX += b.w + 10;
                    });
                },

                check: function(sim) {
                    const inArea = this.blocks.filter(b => b.inCodeArea);
                    inArea.sort((a, b) => a.x - b.x);
                    const code = inArea.map(b => b.text).join("");
                    const cleanCode = code.replace(/\s+/g, '');
                    const cleanGoal = this.challenges[this.currentChallenge].goal.replace(/\s+/g, '');

                    const fb = document.getElementById('sim-feedback');
                    
                    this.isCorrect = false;
                    this.blocks.forEach(b => b.correct = false);

                    if (cleanCode === cleanGoal) {
                        fb.textContent = "Success! Code executed correctly.";
                        fb.className = "mt-3 text-center font-bold text-green-600 min-h-[1.5rem]";
                        inArea.forEach(b => b.correct = true);
                        this.isCorrect = true;

                        this.solvedChallenges.add(this.currentChallenge);
                        if (this.solvedChallenges.size === this.challenges.length) {
                            fb.textContent = "Congratulations! You are a Python Wiz!";
                            fb.className = "mt-3 text-center font-bold text-purple-600 text-xl animate-bounce";
                        }
                    } else if (inArea.length > 0) {
                        fb.textContent = "That's not quite right. Try again!";
                        fb.className = "mt-3 text-center font-bold text-red-500 min-h-[1.5rem]";
                    } else {
                        fb.textContent = "Drag blocks into the Code Area and click 'Run Code'.";
                        fb.innerHTML = `Goal: <code>${this.challenges[this.currentChallenge].goal}</code>`;
                        fb.className = "mt-3 text-center font-bold text-brand-dark min-h-[1.5rem]";
                    }
            }
            }
        };

        // Initialize
        window.onload = function() {
            Book.init();
        };
    </script>
</body>
</html>